标准内存动态分配是动态链表进行管理。由于malloc返回的是一个指针再加上单片机没有mmu，使得分配的指针就像一个个钉子钉在内存中了。这就导致内存管理非常困难，从而产生我们常说的内存碎片。

我们来举一个极端的例子，导致大量内存碎片：

1. 单片机的RAM为1Kbyte，为了说明和计算方便我们忽略掉链表占用的空间，只计算实际存储空间大小。

2. 申请64块内存空间，每块是16字节，那么就会分配完1k字节的空间。即：
for(int i=0; i<64; i++){
    ptr[i] = malloc(16);
}

3. 然后释放掉偶数块内存空间，即：
for(int i=0; i<64; i+=2){
    free(ptr[i] );
}

4. 于是我们释放掉了一半的RAM空间，即有512字节的空间，但是都是非连续的。32块16字节的非连续空间，所以要分配出大于16字节的内存块是分配不出来的。有512字节的空间但只能分配小于16字节的连续空间(除非使用calloc分配非连续空间)，在某些场合原本单片机RAM空间就很急，再加上这种不充分的使用使得程序稳定性大打折扣。

鉴于各中原因本人自己编写了一个内存管理，适合单片机使用的内存管理分配。

算法原理：
定义一个数组作为动态分配的堆空间，低地址空间保存管理数据，高地址空间实际分配给用户的缓存(类似堆栈使用，分配是往中间靠拢)，free时移动高地址用户空间(以时间换空间)，腾出多余未使用的空间，等待malloc来分配。

测试结果
------------mem_info--------------   
sizeof(mem_block)=12  
MEM_START = 134525056(0x804b080)  
MEM_END   = 134525184(0x804b100)  
MEM_SIZE  = 128(0x80)  
----------------------------------  
------test_malloc-------  
p = 0x804b0f6, i=1, id=1, size=10  
f6 b0 04 08 0a 00 00 00 01 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 01 01   
01 01 01 01 01 01 01 01   
------test_malloc-------  
p = 0x804b0ee, i=2, id=2, size=8   
f6 b0 04 08 0a 00 00 00 01 00 00 00    
ee b0 04 08 08 00 00 00 02 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 02 02 02 02 02 02 02 02 01 01   
01 01 01 01 01 01 01 01   
------test_malloc-------  
p = 0x804b0da, i=3, id=3, size=20  
f6 b0 04 08 0a 00 00 00 01 00 00 00   
ee b0 04 08 08 00 00 00 02 00 00 00   
da b0 04 08 14 00 00 00 03 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 03 03 03 03 03 03   
03 03 03 03 03 03 03 03 03 03 03 03   
03 03 02 02 02 02 02 02 02 02 01 01   
01 01 01 01 01 01 01 01   
------test_free-------  
i=2, id = 2  
f6 b0 04 08 0a 00 00 00 01 00 00 00    
e2 b0 04 08 14 00 00 00 03 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 03 03 03 03 03 03 03 03 03 03   
03 03 03 03 03 03 03 03 03 03 01 01   
01 01 01 01 01 01 01 01   
------test_malloc-------  
p = 0x804b0d8, i=4, id=4, size=10  
f6 b0 04 08 0a 00 00 00 01 00 00 00   
e2 b0 04 08 14 00 00 00 03 00 00 00   
d8 b0 04 08 0a 00 00 00 04 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 04 04 04 04 04 04 04 04   
04 04 03 03 03 03 03 03 03 03 03 03   
03 03 03 03 03 03 03 03 03 03 01 01   
01 01 01 01 01 01 01 01   
------test_free-------  
i=1, id = 1  
ec b0 04 08 14 00 00 00 03 00 00 00   
e2 b0 04 08 0a 00 00 00 04 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 04 04 04 04 04 04 04 04 04 04   
03 03 03 03 03 03 03 03 03 03 03 03   
03 03 03 03 03 03 03 03    
------test_malloc-------  
p = 0x804b0ce, i=5, id=5, size=20   
ec b0 04 08 14 00 00 00 03 00 00 00   
e2 b0 04 08 0a 00 00 00 04 00 00 00   
ce b0 04 08 14 00 00 00 05 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 05 05 05 05 05 05   
05 05 05 05 05 05 05 05 05 05 05 05   
05 05 04 04 04 04 04 04 04 04 04 04   
03 03 03 03 03 03 03 03 03 03 03 03   
03 03 03 03 03 03 03 03   
------test_malloc-------  
p = 0x804b0c4, i=6, id=6, size=10   
ec b0 04 08 14 00 00 00 03 00 00 00   
e2 b0 04 08 0a 00 00 00 04 00 00 00   
ce b0 04 08 14 00 00 00 05 00 00 00   
c4 b0 04 08 0a 00 00 00 06 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 06 06 06 06   
06 06 06 06 06 06 05 05 05 05 05 05   
05 05 05 05 05 05 05 05 05 05 05 05   
05 05 04 04 04 04 04 04 04 04 04 04   
03 03 03 03 03 03 03 03 03 03 03 03   
03 03 03 03 03 03 03 03   
------test_malloc-------   
malloc --- fail  
size=10  
ec b0 04 08 14 00 00 00 03 00 00 00     
e2 b0 04 08 0a 00 00 00 04 00 00 00   
ce b0 04 08 14 00 00 00 05 00 00 00   
c4 b0 04 08 0a 00 00 00 06 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 06 06 06 06   
06 06 06 06 06 06 05 05 05 05 05 05   
05 05 05 05 05 05 05 05 05 05 05 05   
05 05 04 04 04 04 04 04 04 04 04 04   
03 03 03 03 03 03 03 03 03 03 03 03   
03 03 03 03 03 03 03 03   
------test_free-------   
i=6, id = 6  
ec b0 04 08 14 00 00 00 03 00 00 00    
e2 b0 04 08 0a 00 00 00 04 00 00 00   
ce b0 04 08 14 00 00 00 05 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 05 05 05 05 05 05   
05 05 05 05 05 05 05 05 05 05 05 05   
05 05 04 04 04 04 04 04 04 04 04 04   
03 03 03 03 03 03 03 03 03 03 03 03   
03 03 03 03 03 03 03 03   
------test_malloc-------   
p = 0x804b0c1, i=8, id=6, size=13  
ec b0 04 08 14 00 00 00 03 00 00 00   
e2 b0 04 08 0a 00 00 00 04 00 00 00   
ce b0 04 08 14 00 00 00 05 00 00 00   
c1 b0 04 08 0d 00 00 00 06 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 08 08 08 08 08 08 08   
08 08 08 08 08 08 05 05 05 05 05 05   
05 05 05 05 05 05 05 05 05 05 05 05   
05 05 04 04 04 04 04 04 04 04 04 04   
03 03 03 03 03 03 03 03 03 03 03 03   
03 03 03 03 03 03 03 03   
------test_buffer-------  
i=5, id = 5, size=20  
ec b0 04 08 14 00 00 00 03 00 00 00    
e2 b0 04 08 0a 00 00 00 04 00 00 00   
ce b0 04 08 14 00 00 00 05 00 00 00    
c1 b0 04 08 0d 00 00 00 06 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 08 08 08 08 08 08 08   
08 08 08 08 08 08 f5 f5 f5 f5 f5 f5   
f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5   
f5 f5 04 04 04 04 04 04 04 04 04 04   
03 03 03 03 03 03 03 03 03 03 03 03   
03 03 03 03 03 03 03 03   
------test_free-------  
i=4, id = 4  
ec b0 04 08 14 00 00 00 03 00 00 00   
d8 b0 04 08 14 00 00 00 05 00 00 00   
cb b0 04 08 0d 00 00 00 06 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 08 08 08 08 08 08 08 08 08   
08 08 08 08 f5 f5 f5 f5 f5 f5 f5 f5   
f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5   
03 03 03 03 03 03 03 03 03 03 03 03   
03 03 03 03 03 03 03 03   
------test_buffer-------  
i=3, id = 3, size=20  
ec b0 04 08 14 00 00 00 03 00 00 00    
d8 b0 04 08 14 00 00 00 05 00 00 00   
cb b0 04 08 0d 00 00 00 06 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 08 08 08 08 08 08 08 08 08   
08 08 08 08 f5 f5 f5 f5 f5 f5 f5 f5   
f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5   
f3 f3 f3 f3 f3 f3 f3 f3 f3 f3 f3 f3   
f3 f3 f3 f3 f3 f3 f3 f3   
------test_malloc-------  
p = 0x804b0bc, i=9, id=7, size=15  
ec b0 04 08 14 00 00 00 03 00 00 00   
d8 b0 04 08 14 00 00 00 05 00 00 00   
cb b0 04 08 0d 00 00 00 06 00 00 00   
bc b0 04 08 0f 00 00 00 07 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
09 09 09 09 09 09 09 09 09 09 09 09   
09 09 09 08 08 08 08 08 08 08 08 08   
08 08 08 08 f5 f5 f5 f5 f5 f5 f5 f5   
f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5   
f3 f3 f3 f3 f3 f3 f3 f3 f3 f3 f3 f3   
f3 f3 f3 f3 f3 f3 f3 f3   
------test_malloc-------  
malloc --- fail  
size=15  
ec b0 04 08 14 00 00 00 03 00 00 00   
d8 b0 04 08 14 00 00 00 05 00 00 00   
cb b0 04 08 0d 00 00 00 06 00 00 00   
bc b0 04 08 0f 00 00 00 07 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
09 09 09 09 09 09 09 09 09 09 09 09   
09 09 09 08 08 08 08 08 08 08 08 08   
08 08 08 08 f5 f5 f5 f5 f5 f5 f5 f5   
f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5   
f3 f3 f3 f3 f3 f3 f3 f3 f3 f3 f3 f3   
f3 f3 f3 f3 f3 f3 f3 f3   
------test_realloc-------  
i=3, id = 3, size=10  
f6 b0 04 08 0a 00 00 00 03 00 00 00    
e2 b0 04 08 14 00 00 00 05 00 00 00   
d5 b0 04 08 0d 00 00 00 06 00 00 00   
c6 b0 04 08 0f 00 00 00 07 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 09 09   
09 09 09 09 09 09 09 09 09 09 09 09   
09 08 08 08 08 08 08 08 08 08 08 08   
08 08 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5   
f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 a3 a3   
a3 a3 a3 a3 a3 a3 a3 a3   
------test_realloc-------  
i=8, id = 6, size=15  
-----ok-----  
f6 b0 04 08 0a 00 00 00 03 00 00 00   
e2 b0 04 08 14 00 00 00 05 00 00 00   
d3 b0 04 08 0f 00 00 00 06 00 00 00   
c4 b0 04 08 0f 00 00 00 07 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 09 09 09 09   
09 09 09 09 09 09 09 09 09 09 09 a8   
a8 a8 a8 a8 a8 a8 a8 a8 a8 a8 a8 a8   
a8 a8 f5 f5 f5 f5 f5 f5 f5 f5 f5 f5   
f5 f5 f5 f5 f5 f5 f5 f5 f5 f5 a3 a3   
a3 a3 a3 a3 a3 a3 a3 a3   
------test_realloc-------  
i=5, id = 5, size=30  
-----ok-----  
f6 b0 04 08 0a 00 00 00 03 00 00 00   
d8 b0 04 08 1e 00 00 00 05 00 00 00   
c9 b0 04 08 0f 00 00 00 06 00 00 00   
ba b0 04 08 0f 00 00 00 07 00 00 00   
00 00 00 00 00 00 00 00 00 00 09 09   
09 09 09 09 09 09 09 09 09 09 09 09   
09 a8 a8 a8 a8 a8 a8 a8 a8 a8 a8 a8   
a8 a8 a8 a8 a5 a5 a5 a5 a5 a5 a5 a5   
a5 a5 a5 a5 a5 a5 a5 a5 a5 a5 a5 a5   
a5 a5 a5 a5 a5 a5 a5 a5 a5 a5 a3 a3   
a3 a3 a3 a3 a3 a3 a3 a3   
------test_realloc-------  
i=8, id = 6, size=20  
-----ok-----  
f6 b0 04 08 0a 00 00 00 03 00 00 00   
d8 b0 04 08 1e 00 00 00 05 00 00 00   
c4 b0 04 08 14 00 00 00 06 00 00 00   
b5 b0 04 08 0f 00 00 00 07 00 00 00   
00 00 00 00 00 09 09 09 09 09 09 09   
09 09 09 09 09 09 09 09 a8 a8 a8 a8   
a8 a8 a8 a8 a8 a8 a8 a8 a8 a8 a8 a8   
a8 a8 a8 a8 a5 a5 a5 a5 a5 a5 a5 a5   
a5 a5 a5 a5 a5 a5 a5 a5 a5 a5 a5 a5   
a5 a5 a5 a5 a5 a5 a5 a5 a5 a5 a3 a3   
a3 a3 a3 a3 a3 a3 a3 a3   
------test_realloc-------  
i=9, id = 7, size=20  
-----ok-----  
f6 b0 04 08 0a 00 00 00 03 00 00 00   
d8 b0 04 08 1e 00 00 00 05 00 00 00   
c4 b0 04 08 14 00 00 00 06 00 00 00   
b0 b0 04 08 14 00 00 00 07 00 00 00   
a9 a9 a9 a9 a9 a9 a9 a9 a9 a9 a9 a9   
a9 a9 a9 a9 a9 a9 a9 a9 a8 a8 a8 a8   
a8 a8 a8 a8 a8 a8 a8 a8 a8 a8 a8 a8   
a8 a8 a8 a8 a5 a5 a5 a5 a5 a5 a5 a5   
a5 a5 a5 a5 a5 a5 a5 a5 a5 a5 a5 a5   
a5 a5 a5 a5 a5 a5 a5 a5 a5 a5 a3 a3   
a3 a3 a3 a3 a3 a3 a3 a3   
------test_realloc-------  
i=9, id = 7, size=13  
f6 b0 04 08 0a 00 00 00 03 00 00 00   
d8 b0 04 08 1e 00 00 00 05 00 00 00    
c4 b0 04 08 14 00 00 00 06 00 00 00   
b7 b0 04 08 0d 00 00 00 07 00 00 00   
00 00 00 00 00 00 00 a9 a9 a9 a9 a9   
a9 a9 a9 a9 a9 a9 a9 a9 a8 a8 a8 a8   
a8 a8 a8 a8 a8 a8 a8 a8 a8 a8 a8 a8   
a8 a8 a8 a8 a5 a5 a5 a5 a5 a5 a5 a5   
a5 a5 a5 a5 a5 a5 a5 a5 a5 a5 a5 a5   
a5 a5 a5 a5 a5 a5 a5 a5 a5 a5 a3 a3   
a3 a3 a3 a3 a3 a3 a3 a3   
------test_free-------  
i=0, id = 0  
------test_free-------  
i=1, id = 1  
------test_free-------  
i=2, id = 2  
------test_free-------  
i=3, id = 3  
e2 b0 04 08 1e 00 00 00 05 00 00 00   
ce b0 04 08 14 00 00 00 06 00 00 00   
c1 b0 04 08 0d 00 00 00 07 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 a9 a9 a9 a9 a9 a9 a9   
a9 a9 a9 a9 a9 a9 a8 a8 a8 a8 a8 a8   
a8 a8 a8 a8 a8 a8 a8 a8 a8 a8 a8 a8   
a8 a8 a5 a5 a5 a5 a5 a5 a5 a5 a5 a5   
a5 a5 a5 a5 a5 a5 a5 a5 a5 a5 a5 a5   
a5 a5 a5 a5 a5 a5 a5 a5   
------test_free-------  
i=4, id = 4  
------test_free-------  
i=5, id = 5  
ec b0 04 08 14 00 00 00 06 00 00 00   
df b0 04 08 0d 00 00 00 07 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 a9   
a9 a9 a9 a9 a9 a9 a9 a9 a9 a9 a9 a9   
a8 a8 a8 a8 a8 a8 a8 a8 a8 a8 a8 a8   
a8 a8 a8 a8 a8 a8 a8 a8   
------test_free-------  
i=6, id = 6  
f3 b0 04 08 0d 00 00 00 07 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 a9 a9 a9 a9 a9   
a9 a9 a9 a9 a9 a9 a9 a9   
------test_free-------  
i=7, id = 0  
------test_free-------  
i=8, id = 6  
------test_free-------  
i=9, id = 7  
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00 00 00 00 00   
00 00 00 00 00 00 00 00   